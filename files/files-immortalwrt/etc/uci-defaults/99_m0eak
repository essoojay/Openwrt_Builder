#!/bin/sh
until [ "$( opkg list-installed 2>/dev/null| grep -c "^kernel")" -ne '0' ]; do
  sleep 1
done
if [ "$( opkg list-installed 2>/dev/null| grep -c "^mosdns")" -ne '0' ];then
  uci set mosdns.config.enabled='1'
  uci set mosdns.config.redirect='0'
  uci set mosdns.config.custom_local_dns='1'
  uci set mosdns.config.enable_http3_local='0'
  uci set mosdns.config.dns_leak='1'
  uci add_list mosdns.config.local_dns='https://dns.alidns.com/dns-query'
  uci add_list mosdns.config.local_dns='https://doh.pub/dns-query'
  uci add_list mosdns.config.local_dns='https://doh.360.cn/dns-query'
  uci add_list mosdns.config.remote_dns='https://doh.opendns.com/dns-query'
  uci add_list mosdns.config.remote_dns='https://dns.google/dns-query'
  uci add_list mosdns.config.remote_dns='https://dns.cloudflare.com/dns-query'
  uci add_list mosdns.config.remote_dns='https://dns.quad9.net/dns-query'
  uci commit mosdns
  /etc/init.d/mosdns restart
fi
uci set luci.main.mediaurlbase='/luci-static/bootstrap'
uci commit luci
uci set turboacc.config.bbr_cca='1'
uci commit turbooacc
if [ "$(grep -c "0 */1 * * * sync && echo 3 > /proc/sys/vm/drop_caches" /etc/crontabs/root)" -eq '0' ];then
  echo "0 */1 * * * sync && echo 3 > /proc/sys/vm/drop_caches" >>/etc/crontabs/root
fi

need_restart=0
if [ "$(opkg list-installed 2>/dev/null | grep -c "^luci-app-tailscale")" -ne '0' ] && [ "$(cat /usr/share/luci/menu.d/luci-app-tailscale.json | grep -c "services")" -ne '0' ]; then
  sed -i 's/services/vpn/g' /usr/share/luci/menu.d/luci-app-tailscale.json && rm -rf luci-indexcache.*.json
  need_restart=1
fi
if [ "$(opkg list-installed 2>/dev/null | grep -c "^luci-app-ttyd")" -ne '0' ] && [ "$(cat /usr/share/luci/menu.d/luci-app-ttyd.json | grep -c "services")" -ne '0' ]; then
  sed -i 's/services/system/g' /usr/share/luci/menu.d/luci-app-ttyd.json && rm -rf luci-indexcache.*.json
  need_restart=1
fi
if [ "$need_restart" -eq '1' ]; then
  /etc/init.d/rpcd restart
fi

sed -i "s/option rollback '90'/option rollback '30'/" /etc/config/luci
sed -i "s/option holdoff '4'/option holdoff '2'/" /etc/config/luci
sed -i "s/option timeout '5'/option timeout '3'/" /etc/config/luci
sed -i "s/option display '1.5'/option display '1'/" /etc/config/luci
sed -i "/^DISTRIB_DESCRIPTION='/s/'$/ Compiled by m0eak'/" /etc/openwrt_release
exit 0
